<link rel="import" href="../components/format-number-behavior.html">
<link rel="import" href="../components/common-logic.html">
<link rel="import" href="../components/month-behavior.html">
<link rel="import" href="./components/admin-dialog-use-welfare.html">
<link rel="import" href="./components/employee-manage.html">

<link rel="import" href="./../components/page-style.html">

<dom-module id="page-admin-manage">
    <style include="page-style gl-styles gl-size iron-flex iron-flex-factors iron-flex-alignment">
        * {
            font-family: 'CSChatThaiUI', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        .head-text {
            font-size: var(--font-size-h4);
            margin: 15px 15px 15px 15px;
        }
        table.gl-table-default {
            width: 98%;
            border: 1px solid #ddd;
            /*margin: 15px;*/
        }
        .label,
        .inpit {
            font-size: var(--font-size-h5)
        }
        .label {
            text-align: right;
            padding-right: 5px;
        }
        .left {
            text-align: left;
        }
        .right {
            text-align: right;
        }
        fieldset {
            margin: 15px;
        }
        .header {
            padding: 10px;
            font-size: 35px;
        }
    </style>
    <template>
        <div class="xcontainer">
            <!--<iron-pages selected="{{pages}}">-->
            <!--<section>-->
            <div class="header-page container">
                จัดการข้อมูลส่วนตัว
            </div>
            <gl-form-panel set-padding="10px 20px 10px 20px" set-border="1px">
                <gl-form-panel-body label="" set-padding="10px" set-border="1px">
                    <div class="horizontal end-justified layout">
                        <paper-button class="gl-btn-info" on-tap="editData" raised>แก้ไขข้อมูลส่วนตัว</paper-button>
                    </div>

                </gl-form-panel-body>
                <gl-form-panel-body label="" set-padding="10px" set-border="1px">
                    <fieldset>
                        <legend>ข้อมูลพนักงาน :</legend>
                        <div class="flex content horizontal start-justified layout">
                            <div class="flex">ชื่อ : [[data.prefix_name]] [[data.firstname]] [[data.lastname]]</div>
                            <div class="flex">รหัสพนักงาน : [[data.emp_no]]</div>
                        </div>
                        <div class="flex content horizontal start-justified layout">
                            <div class="flex">สถานภาพการทำงาน : [[data.active_name]]</div>
                            <div class="flex">ตำแหน่ง : [[data.position_name]]</div>
                        </div>
                        <div class="flex content horizontal start-justified layout">
                            <div class="flex">ภาควิชา : [[data.department_name]]</div>
                            <div class="flex">คณะ : [[data.faculty_name]]</div>
                        </div>
                    </fieldset>
                    <div class="content horizontal start-justified layout">
                        [[setYear(year)]]
                        <gl-combo-box label="ปีงบประมาณ" items="{{year}}" value="{{seleterYear}}" item-label-path="year" item-value-path="year" on-value-changed="gerYearWelfare"></gl-combo-box>


                    </div>
                </gl-form-panel-body>

                <gl-form-panel-body label="" set-padding="10px" set-border="1px">
                    <div class="head-text">
                        สวัสดิการที่ได้รับสิทธิ์
                    </div>
                    <div class="content horizontal center-justified layout">
                        <table class="gl-table-default">
                            <thead class="table-head">
                                <tr>
                                    <th style="width: 5%" rowspan="2">ลำดับ</th>
                                    <th style="width: 40%" rowspan="2">สวัสดิการที่สามารถใช้ได้</th>
                                    <th style="width: 45%" colspan="3">จำนวนเงิน (บาท)</th>
                                    <!--<th style="width: 15%">จำนวนเงินที่ใช้ไปแล้ว (บาท)</th>
                                <th style="width: 15%">จำนวนเงินที่คงเหลือ (บาท)</th>-->
                                    <th style="width: 15%" rowspan="2">ดำเนินการ</th>
                                </tr>
                                <tr>
                                    <!--<th style="width: 5%">ลำดับ</th>-->
                                    <!--<th style="width: 40%">สวัสดิการที่สามารถใช้ได้</th>-->
                                    <th style="width: 15%">วงเงิน </th>
                                    <th style="width: 15%">ใช้ไปแล้ว </th>
                                    <th style="width: 15%">คงเหลือ </th>
                                    <!--<th style="width: 15%">ขอใช้ (บาท)</th>-->
                                </tr>
                            </thead>
                            <tbody class="table-body">

                                <template is="dom-repeat" items={{data.group_welfares}}>
                                    <tr>
                                        <td>[[_Obindex(index)]]</td>
                                        <td style="text-align: left;">[[item.description]] [[item.check_onetime_thai]]</td>
                                        <td style="text-align: right;">[[formatNumber(item.budget)]]</td>
                                        <td style="text-align: right;">[[formatNumber(item.budget_use)]]</td>
                                        <td style="text-align: right;">[[formatNumber(item.budget_balance)]]</td>
                                        <td>
                                            <paper-button class="gl-btn-primary gl-small" raised on-tap="usewelfare" data="[[item]]" disabled="[[checkWelfareFull(item)]]">ขอใช้</paper-button>
                                        </td>
                                    </tr>
                                </template>
                                <template is="dom-if" if={{_ObIsHave(data.group_welfares)}}>
                                    <tr>
                                        <td colspan="6" style="text-align: center">ไม่มีข้อมูล</td>
                                    </tr>
                                </template>

                            </tbody>
                        </table>
                    </div>
                </gl-form-panel-body>
                <gl-form-panel-body label="" set-padding="10px" set-border="1px">
                    <div class="head-text">
                        สวัสดิการที่ได้ใช้สิทธิ์ไปแล้ว
                    </div>
                    <div class="content horizontal center-justified layout">
                        <table class="gl-table-default">
                            <thead class="table-head">
                                <tr>
                                    <th style="width: 10%">ลำดับ</th>
                                    <th style="width: 25%">สวัสดิการที่ใช้</th>
                                    <th style="width: 15%;text-align: right;">จำนวนเงินที่ใช้ (บาท)</th>
                                    <th style="width: 10%">วันที่ขอ</th>
                                    <th style="width: 10%">วันอนุมัติ</th>
                                    <th style="width: 10%">สถานะ</th>
                                    <th style="width: 25%">ไฟล์</th>

                                </tr>
                            </thead>
                            <tbody class="table-body">
                                <template is="dom-repeat" items={{data.history_welfare}}>
                                    <tr>
                                        <td>[[_Obindex(index)]]</td>
                                        <td style="text-align: left;">[[item.description]] </td>
                                        <td style="text-align: right;">[[formatNumber(item.budget_use)]]</td>
                                        <td>
                                             [[toThaiDate(item.date_use)]]
                                        </td>
                                        <td>
                                            <div style="text-align: center">
                                                <template is="dom-if" if={{!item.date_approve}}>
                                                    รอการอนุมัติ
                                                </template>
                                                <template is="dom-if" if={{item.date_approve}}>
                                                    [[toThaiDate(item.date_approve)]]
                                                </template>
                                            </div>
                                        </td>
                                        <td>[[item.status]]</td>
                                        <td style="text-align: left;">
                                            <template is="dom-if" if={{item.file}}>
                                                <template is="dom-repeat" items={{item.file}}>
                                                    <a href="" on-tap=downloadFile data="[[item]]">[[item.name]]</a>
                                                </template>
                                            </template>
                                            <template is="dom-if" if={{_ObIsHave(item.file)}}>
                                                <div style="text-align: center;">ไม่ได้อัพโหลดไฟล์</div>
                                            </template>
                                        </td>
                                    </tr>
                                </template>
                                <template is="dom-if" if={{_ObIsHave(data.history_welfare)}}>
                                    <tr>
                                        <td colspan="8" style="text-align: center">ไม่มีข้อมูล</td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                </gl-form-panel-body>
                <!--<gl-form-panel-footer label="Footer" set-padding="10px">
                
                </gl-form-panel-footer>-->
            </gl-form-panel>
            <paper-dialog id="welfare_budget">
                <admin-dialog-use-welfare id="admin-dialog-use-welfare" data="{{dataDialog}}" disabled="[[disabled]]"></admin-dialog-use-welfare>
                <div class="flex horizontal end-justified layout">
                    <paper-button raised class="gl-btn-primary" on-tap="getwelfare">ใช้งาน</paper-button>
                </div>
            </paper-dialog>
            <!--</section>-->
            <!--<section>
                    <employee-manage data="{{data}}"></employee-manage>
                </section>-->
            <!--</iron-pages>-->
        </div>

        <panel-right id="test" title="{{title}}">
            <employee-manage disabled="[[isEnable]]"></employee-manage>
        </panel-right>
    </template>
    <script>
        Polymer({
            is: 'page-admin-manage',
            behaviors: [ReduxBehavior, FormatNumberBehavior, nylonBehavior,
                commonLogic, userWelfareAction, uploadAction, commonDataAction,
                MonthBehavior],
            listeners: {
                'back-page': 'changePage',
                'close-panel-right':'closePanelRight'
            },
            observers: ['checkData(seleterYear,id)'],
            properties: {
                data: {
                    statePath: 'userWelfare.welfare_employee',
                },
                year: {
                    statePath: 'userWelfare.list',
                    type: Number
                },
                usewelfareProp: {
                    statePath: 'userWelfare.select_use_welefares',
                    type: Object,
                },
                pages: {
                    type: Number,
                    value: 0
                }
            },
            ready: function () {
                this._getcommon();
            },
            nylonPageActive: function () {
                this.id = window.location.pathname.split('/')[2];
                this.WELFARE_LIST_YEAR();
            },
            setDate(data){
                console.log(data);
                console.log(this.changeTime(data,+7));
            },
            changeTime:function(data,timeZone) {
                let time
                data.map((item,index) => {
                    for (var prop in item) {
                        if (prop.indexOf('date') >= 0 && prop !== 'updater') {
                            time = new Date(item[prop])
                            // console.log(data[index][prop]);
                            data[index][prop] = new Date(time.setHours(time.getHours() + timeZone)).toISOString()
                            // console.log(new Date(data[index][prop]).toISOString());
                        }
                        // console.log(typeof item[prop] === 'object');
                        if (typeof item[prop] === 'object')
                            this.changeTime(item[prop],timeZone)
                    }
                })
                return data
            },
            checkData(year, id) {
                if (year != '') {
                    var datas = {
                        id: id,
                        year: year - 543
                    }
                    this.dispatchAction('LIST_EMPLOYEES_WELFARE', datas);
                }
            },
            setYear(year) {
                try {
                    this.set('seleterYear', year[year.length - 1].year)
                    // console.log(year[year.length-1].year);
                    // console.log(this.seleterYear);
                } catch (error) {

                }
            },
            _btnReject(status){
                return status == 'request'
            },
            checkWelfareFull(data){
                if(data.budget_balance <= 0)
                    return true
            },
            btnCancel(e){
                // console.log(e.currentTarget.data);
                let newData = [{id:e.currentTarget.data.history_welfare_id}]
                this.fire('toast', {
                    status: 'openDialog',
                    text: 'ต้องการยกเลิกการขอใช่หรือไม่ ?',
                    confirmed: (result) => {
                        if (result == true) {
                            this.dispatchAction('USER_CANCEL_USE_WELFARE', newData);
                            this.fire('_getReloadData','')
                        }
                    }
                })
            },
            gerYearWelfare(e) {
                if (typeof this.data != 'undefined') {
                    // console.log(this.data);
                    if (e.detail.value)
                        var id = this.data.id;
                    if (typeof id != 'undefined') {
                        this.dispatchAction('EMPLOYEE_GET_WELFARES', id, e.detail.value - 543);
                    }
                }
            },
            usewelfare(e) {
                let data = new Object();
                // console.log(this.data.id);
                data.title = e.model.item.description
                data.emp_id = this.data.id
                data.welfare_id = e.model.item.welfare_id
                data.budget = e.model.item.budget
                data.budget_cover = e.model.item.budget_balance
                data.budget_use = e.model.item.budget_balance
                data.status = true
                data.onetime = e.model.item.onetime
                // data.year = new Date().getFullYear()
                data.group_id = e.model.item.group_id
                this.set('disabled', e.model.item.onetime)
                this.$$('#welfare_budget').open()
                // console.log(e.model.item.budget_balance);
                // console.log(data);
                this.dataDialog = data;
                // console.log(this.dataDialog);
                // console.log(data);
                this.dispatchAction('EMPLOYEE_USE_SELETE_WELFARE', this.dataDialog);
            },
            getwelfare() {
                this.usewelfareProp.document_ids = this.$$('admin-dialog-use-welfare').keepFile()
                let newData = this.usewelfareProp
                newData.budget_use = Number(newData.budget_use)
                newData.budget_balance = newData.budget_cover - newData.budget_use
                newData.date_approve = newData.date_approve+'T00:00:00+07:00'
                newData.date_use = newData.date_use+'T00:00:00+07:00'
                // console.log(newData);
                this.$$('#welfare_budget').close()
                
                if (this.$$('#admin-dialog-use-welfare').validateForm('.required')) {
                    this.dispatchAction('EMPLOYEE_USE_WELFARE', newData);
                }
            },
            _checkApprove(status) {
                switch (status) {
                    case 'request':
                        return 'รออนุมัติ'
                        break;
                    case 'approve':
                        return 'อนุมัติ'
                        break;
                    case 'reject':
                        return 'ไม่อนุมัติ'
                        break;
                    default:

                }
            },
            editData() {
                this.set('title', 'แก้ไขข้อมูลส่วนตัว')
                this.isEnable = true;
                this.$$('panel-right').open();
            },
            changePage: function (page) {
                this.$$('panel-right').close();
                // if (page.detail != 0) {
                //     this.pages = page.detail;
                // }
                // else {
                //     this.pages = page.detail;
                // }
            },
            downloadFile(e) {
                console.log(e.currentTarget.data);
                window.open('/api/file/download/' + e.currentTarget.data.id);
                // this.dispatchAction('UPLOAD_GET_FILE',e.currentTarget.data.id );
            },
            _getcommon: function () {
                this.dispatchAction('COMMONDATA_DATA_ACADEMIC');
                this.dispatchAction('COMMONDATA_DATA_DEPARTMENT');
                this.dispatchAction('COMMONDATA_DATA_ACTIVE');
                this.dispatchAction('COMMONDATA_DATA_FACULTY');
                this.dispatchAction('COMMONDATA_DATA_GENDER');
                this.dispatchAction('COMMONDATA_DATA_MATIER');
                this.dispatchAction('COMMONDATA_DATA_POSITION');
                this.dispatchAction('COMMONDATA_DATA_PREFIXNAME');
                this.dispatchAction('COMMONDATA_DATA_TYPE_EMPLOYEE');
            },
            closePanelRight(){
                this.$$('panel-right').close();
            }
        });
    </script>
</dom-module>