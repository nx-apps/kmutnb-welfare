<link rel="import" href="./../../../../bower_components/paper-fab/paper-fab.html">

<dom-module id="list-user">
    <template>
        <style is="custom-style" include="gl-color gl-table flex-style">
            paper-material {
                margin: 10px;
                background-color: var(--gl-white-color);
                padding-top: 15px;
                padding-bottom: 15px;
            }


            .table-detail {
                margin: 20px;
            }


            table.gl-table-default {
                border: 1px solid #ddd;
            }

            .text-head {
                margin-left: 20px;
                font-weight: bold;
            }

            paper-fab {
                position: fixed;
                right: 25px;
                bottom: 25px;
                color: #fff;
                --paper-fab-background: var(--paper-light-blue-500);
                --paper-fab-keyboard-focus-background: var(--paper-light-blue-900);
            }
        </style>
        <div class="container">
            <!--<div class="horizontal layout">
                <paper-button raised on-tap="back_page">back</paper-button>
            </div>-->

            <paper-material elevation="1">
                <div class="table-detail">
                    <template is="dom-if" if={{isSearch}}>
                        <div class="container flex-horizontal-with-ratios">
                            <div class="flex3child"></div>
                            <div class="flex2child">
                                <gl-form-input no-label-float value="{{searchInput}}"></gl-form-input>
                            </div>
                            <div>     
                                <paper-icon-button icon="search" on-tap="searchTable"></paper-icon-button>
                            </div>
                        </div>
                        <table class="gl-table-default">
                            <thead class="table-head">
                                <tr>
                                    <!--<th style="width:10%;">
                                        <paper-checkbox checked="{{dataCheck}}" on-tap="selectAll"></paper-checkbox>กระทำ
                                    </th>-->
                                    <th style="width:10%;">รหัสพนักงาน</th>
                                    <th style="width:15%;">ชื่อ นามสกุล</th>
                                    <th style="width:25%;">ตำแหน่ง</th>
                                    <th style="width:15%;">ตำแหน่งวิชาการ</th>
                                </tr>
                            </thead>
                            <tbody class="table-body">
                                <template is="dom-repeat" items={{newList}}>
                                    <tr data="[[item]]" on-tap="chagePageDetail">
                                        <!--<td style="text-align: center">
                                            <paper-checkbox checked="{{item.check}}" checked></paper-checkbox>
                                        </td>-->
                                        <td>[[item.emp_no]]</td>
                                        <td>[[item.prefix_name]] [[item.firstname]] [[item.lastname]]</td>
                                        <td>[[item.position_name]]</td>
                                        <td>[[item.academic_name]]</td>
                                    </tr>
                                </template>
                                <template is="dom-if" if={{checkData(item.employee)}}>
                                    <tr>
                                        <td colspan="7" style="text-align: center;">ไม่มีข้อมูล</td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </template>
                    <template is="dom-if" if={{!isSearch}}>
                        <table class="gl-table-default">
                            <thead class="table-head">
                                <tr>
                                    <th style="width:15%;" hidden="{{!checkBox}}">
                                        <paper-checkbox checked="{{dataCheck}}" on-tap="selectAll"></paper-checkbox>เลือกทั้งหมด
                                    </th>
                                    <th style="width:10%;">รหัสพนักงาน</th>
                                    <th style="width:15%;">ชื่อ นามสกุล</th>
                                    <th style="width:25%;">ตำแหน่ง</th>
                                    <th style="width:15%;">ตำแหน่งวิชาการ</th>
                                    <th>ยอดที่ใช้</th>
                                    <th>ยอดคงเหลือ</th>
                                </tr>
                            </thead>
                            <tbody class="table-body">
                                <template is="dom-repeat" items={{newListSearch}}>
                                    <tr on-tap="chagePage" data="[[item]]">
                                        <td style="text-align: center" hidden="{{!checkBox}}">
                                            <paper-checkbox checked="{{item.check}}" disabled="{{!item.admin_use}}"></paper-checkbox>
                                        </td>
                                        <td>[[item.emp_no]]</td>
                                        <td>[[item.prefix_name]] [[item.firstname]] [[item.lastname]]</td>
                                        <td>[[item.position_name]]</td>
                                        <td>[[item.academic_name]]</td>
                                        <td>[[item.value_use]]</td>
                                        <td>[[item.value_budget]]</td>
                                    </tr>
                                </template>
                                <template is="dom-if" if={{checkData(item.employee)}}>
                                    <tr>
                                        <td colspan="7" style="text-align: center;">ไม่มีข้อมูล</td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </template>
                </div>
            </paper-material>

        </div>
        <div hidden="{{paperFab}}">
            <paper-fab icon="send" on-tap="confirmSend"></paper-fab>
        </div>

    </template>
    <script>
        Polymer({
            is: 'list-user',
            behaviors: [ReduxBehavior],
            observers: ['showBtn(newListSearch.*)'],
            properties: {
                list: {
                    statePath: 'userWelfare.list_user',
                    observer:'getList'
                },
                listSearch: {
                    statePath: 'userWelfare.listSearch',
                    observer:'getListSearch'
                },
                checkBox: {
                    type: Boolean,
                    value: false,
                    observer: 'hiddenCheckBox'
                },
                paperFab: {
                    type: Boolean,
                    value: true
                }
            },
            checkData: function (data) {
                if (typeof data != 'undefined') {
                    if (data.length == 0) {
                        return true;
                    }
                    else {
                        return false;
                    }
                    // console.log(data.length);
                }
            },
            hiddenCheckBox: function (check) {
                if (typeof check == 'undefined') {
                    this.checkBox = false;
                }
            },
            showBtn: function (show) {
                var check = show.base.filter((item) => {
                    return item.check == true
                })
                console.log(check);
                if (check.length != 0) {
                    this.paperFab = false;
                }
                else {
                    this.paperFab = true;
                }
            },
            selectAll: function (e) {
                var check = e.target.checked;
                if (check == true) {
                    this.newListSearch.map((item, index) => {
                        console.log(item.admin_use);
                        if (item.admin_use == true) {
                            this.set('newListSearch.' + index + '.check', true);
                        } else {
                            this.set('newListSearch.' + index + '.check', false);
                        }

                    })
                }
                else {
                    this.newListSearch.map((item, index) => {
                        this.set('newListSearch.' + index + '.check', false);
                    })
                }

            },
            back_page: function () {
                this.fire('back_page_welfare');
            },
            confirmSend: function () {
                this.fire('toast', {
                    status: 'openDialog',
                    text: 'ต้องการอนุมัติข้อมูลใช่หรือไม่ ?',
                    confirmed: this.insertData.bind(this),
                })
            },
            insertData: function (check) {
                if (check == true) {
                    var newData = this.newListSearch.filter((item) => {
                        return item.check == true;
                    })
                    var saveData = newData.map((item) => {
                        var newItem = {
                            group_id: item.group_id,
                            year: item.year,
                            emp_id: item.emp_id,
                            welfare_id: item.welfare_id,
                            use_budget: item.value_budget - item.value_use,
                            date_approve: new Date().toISOString(),
                            date_use: new Date().toISOString(),
                            status: true
                        };
                        return newItem;
                    })
                    //    console.log(saveData);
                    this.dispatchAction('USER_INSERT', saveData)
                }

            },
            selectTable: function (id) {
                if (id == true) {
                    this.isSearch = true;
                }
                else {
                    this.isSearch = false;
                }
            },
            chagePage: function (e) {
                var item = e.currentTarget.data;
                var datas = {
                    id: item.emp_id,
                    year: item.year
                }
                // console.log(datas);
                this.dispatchAction('LIST_EMPLOYEES_WELFARE', datas);
                var check = e.target.is;
                if (check != 'paper-checkbox') {
                    this.fire('select-page', 1)
                }
                // console.log(e.target.is);
            },
            chagePageDetail: function (e) {
                console.log(e.currentTarget.data);
                // var item = e.currentTarget.data;
                // var datas = {
                //     id: item.id,
                //     year: item.year
                // }
                // this.dispatchAction('LIST_EMPLOYEE_WELFARE', datas);
            },
            getList:function(list){
                this.newList = list;
            },
            getListSearch:function(list){
                this.newListSearch = list;
            },
            searchTable:function(e){
                let arr=[];
                var storeData = this.list;
                this.newList = storeData;
                var input = this.searchInput;
                var feild = Object.getOwnPropertyNames(this.newList[0]).sort();
                if(input != ''){
                    this.newList.map((item,index)=>{
                        for(var i = 0; i < feild.length;i++){
                            var getFeild = feild[i];
                            if(String(item[getFeild]).search(input) > -1){
                                arr.push(item)   
                            }
                            else{
                                // console.log(this.newList);
                                this.newList = [];
                            }
                        
                        }
                    })
                    console.log(arr);
                    this.newList = arr
                }
                else{
                    console.log(storeData);
                    this.newList = storeData;
                }
            }
        });
    </script>
</dom-module>