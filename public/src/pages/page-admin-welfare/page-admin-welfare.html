<link rel="import" href="components/welfare-panel.html">
<!--<link rel="import" href="components/group-welfare-chart.html">-->
<link rel="import" href="./../components/page-style.html">
<link rel="import" href="./../components/common-logic.html">



<dom-module id="page-admin-welfare">
    <template>
        <style include="page-style iron-flex iron-flex-factors iron-flex-alignment">
            paper-material {
                /*background-color: var(--gl-white-color);*/
                padding: 0px;
            }
            
            * {
                font-family: 'CSChatThaiUI', sans-serif;
                -webkit-font-smoothing: antialiased;
            }
            
            .table-detail {
                margin: auto;
                /*width: 80%;*/
                padding: 20px;
            }
            
            table.gl-table-default {
                width: 100%;
                border: 1px solid #ddd;
            }
            
            .title-text {
                font-family: 'CSChatThaiUI', sans-serif;
                -webkit-font-smoothing: antialiased;
                font-weight: bold;
                margin-top: 35px;
                font-size: 20px;
            }
            paper-dialog[id="clone_welfare"] {
                --paper-dialog: {
                box-sizing: border-box;
                width: 360px;
                height: 640px;
                }
            }
            paper-dialog[id="dialogInput"] {
                --paper-dialog: {
                width: 500px;
                }
            }
        </style>
        <div class="xcontainer">
            <div class="header-page">จัดการสวัสดิการ</div>
            <!--<group-welfare-chart></group-welfare-chart>-->
            <div class="horizontal layout">
                <!--<paper-button raised style="margin: 20px" class="gl-btn-primary" on-tap="_print">
                <iron-icon icon="print"></iron-icon>ออกรายงาน</paper-button>-->
                <div class="flex horizontal start-justified layout">
                    <gl-form-dropdown-menu style="margin-left:20px;" label="ปี" placeholder="เลือกปี">
                        <paper-menu class="dropdown-content" attr-for-selected="value" selected="{{selectYear}}">
                            <template is="dom-repeat" items={{list_year}}>
                                <paper-item value="[[item.year]]">[[item.year]]</paper-item>
                            </template>
                        </paper-menu>
                    </gl-form-dropdown-menu>
                </div>
                <div class="flex horizontal end-justified layout">
                    <div>
                        <paper-button raised style="margin: 20px 10px 20px 20px;" class="gl-btn-info" on-tap="_openDialog">
                            <iron-icon icon="icons:content-copy"></iron-icon>คัดลอกสวัสดิการ</paper-button>
                        <paper-button raised style="margin: 20px" class="gl-btn-primary" on-tap="_insert">
                            <iron-icon icon="add"></iron-icon>เพิ่มสวัสดิการ</paper-button>
                    </div>
                </div>

            </div>
            <div class="container">
                <div class="table-detail">
                    <paper-material elevation="1">
                        <table class="gl-table-default">
                            <thead class="table-head">
                                <tr>
                                    <th style="text-align:center; width:15%;">ปี</th>
                                    <th>ชื่อสวัสดิการ</th>
                                    <th style="text-align:center">จำนวนผู้มีสิทธิ</th>
                                    <th style="text-align:center">จำนวนผู้ใช้สิทธิ</th>
                                    <th style="text-align:center;width:15%;">ยอดเต็ม (บาท)</th>
                                    <th style="text-align:center;width:15%;">ยอดที่ใช้ (บาท)</th>
                                    <th style="width:15%;text-align:center;">เครื่องมือ</th>
                                </tr>
                            </thead>
                            <tbody class="table-body">
                                <template is="dom-repeat" items="{{list}}">
                                    <tr style="cursor:pointer;">
                                        <td style="text-align:center">[[item.year]]</td>
                                        <td>[[item.group_welfare_name]]</td>
                                        <td style="text-align:center">[[item.emp_budget]]</td>
                                        <td style="text-align:center">[[item.emp_use]]</td>
                                        <td style="text-align:right">[[formatNumber(item.value_budget)]]</td>
                                        <td style="text-align:right">[[formatNumber(item.value_use)]]</td>
                                        <td style="text-align:center">
                                            <paper-icon-button data="[[item]]" icon="icons:create" on-tap="_edit" title="แก้ไขสวัสดิการ"></paper-icon-button>
                                        </td>
                                    </tr>
                                </template>
                                
                                <template is="dom-if" if={{_ObIsHave(list)}}>
                                    <tr>
                                        <td colspan="7"> ไม่มีข้อมูล</td>
                                    </tr>
                                </template>
                                
                            </tbody>
                        </table>
                    </paper-material>
                </div>
            </div>

            <panel-right title="{{title}}">
                <iron-pages selected="{{pages}}">
                    <div>
                        <welfare-panel is-enable="[[active]]"></welfare-panel>
                    </div>
                </iron-pages>
            </panel-right>
            
            <paper-dialog id="clone_welfare" modal>
                <div class="container">
                    <div class="vertical layout">
                        <div style="font-size:18px; font-style:bold;">เลือกปีสวัสดิการที่ต้องการคัดลอก</div>
                        [[_cloneData(year)]]
                        <gl-form-dropdown-menu label="ปีสวัสดิการ" placeholder="เลือกปี">
                            <paper-menu class="dropdown-content" attr-for-selected="value" selected="{{year}}">
                                <template is="dom-repeat" items={{list_year}}>
                                    <paper-item value="[[item.year]]">[[item.year]]</paper-item>
                                </template>
                            </paper-menu>
                        </gl-form-dropdown-menu>
                    </div>
                    <template is="dom-if" if={{_obData(data_clone)}}>
                        <table class="gl-table-default">
                            <thead class="table-head">
                                <tr>
                                    <th><paper-checkbox on-tap="_changeselectDataAll" checked="{{selectDataAll}}"></paper-checkbox>เลือกทั้งหมด</th>
                                    <th>ชื่อสวัสดิการ</th>
                                </tr>
                            </thead>
                            <tbody class="table-body">
                                <template is="dom-repeat" items="{{data_clone}}">
                                    <tr style="cursor:pointer;">
                                        <td style="text-align:center"><paper-checkbox on-tap="_checkData" checked="{{item.check}}"></paper-checkbox></td>
                                        <td style="text-align:left" on-tap="_clickCheckedData">[[item.group_welfare_name]]</td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </template>
                    {{_obChecked(data_clone.*)}}
                </div>
                <div class="buttons">
                    <paper-button dialog-dismiss autofocus>ยกเลิก</paper-button>
                    <paper-button autofocus class="gl-btn-primary" on-tap="_submitClone" hidden="{{isHidden}}">คัดลอก</paper-button>
                </div>
            </paper-dialog>

            <paper-dialog id="dialogInput" modal>
                <div class="horizontal end-justified layout">
                    <paper-icon-button icon="icons:close"  dialog-dismiss></paper-icon-button>
                </div>
                <div style="font-size:18px; font-style:bold;">คัดลอกเป็นสวัสดิการปี</div>
                <gl-form-input class="checkValidate" required label="ปี" allowed-pattern="[0-9]" 
                maxlength="4" value="{{yearClone.year}}" placeholder="กรุณากรอกปี พ.ศ." on-keyup="_insertClone"></gl-form-input>
            </paper-dialog>
        </div>

    </template>
    <script>
        Polymer({
            is: 'page-admin-welfare',
            behaviors: [ReduxBehavior, FormatNumberBehavior, nylonBehavior, groupWelfareAction, welfareAction, nylonLocalizeBehavior,commonLogic],
            observers: ['changeYear(selectYear)'],
            properties: {
                list: {
                    statePath: 'groupWelfare.list'
                },
                list_year: {
                    statePath: 'groupWelfare.list_year'
                },
                data_clone:{
                    statePath: 'groupWelfare.data_clone'
                },
                pages: {
                    type: Number,
                    value: 0
                },
                yearClone:{
                    type: Object,
                    value: {}
                },
                selectDataAll: {
                    type: Boolean,
                    value: false
                    // observer: '_changeselectDataAll'
                },
                isHidden:{
                    type: Boolean,
                    value: true
                }
            },
            listeners:
            {
                'closePanel': 'close_panel',
                'refresh_group' : 'changeYear'
            },
            nylonPageActive: function () {
                let year = new Date().getFullYear();
                var newYear = year + 543;
                this.selectYear = newYear;
                // this.WELFARE_LIST();
                this.GET_YEAR();
            },
            select_welfare: function (e) {
                // console.log(e.currentTarget.data);
                this.$$('panel-right').open();
                this.$$('welfare-detail').setPage(0);
                // this.pageDetail = '0';
                this.pages = 1;
                this.set('title', this.title = "ข้อมูลสวัสดิการ");
                this.dataSelect = e.currentTarget.data;
                var id = e.currentTarget.data.id;
                this.LIST_WELFARE_ID(id);
            },
            close_panel: function () {
                this.$$('panel-right').close();
            },
            clearData: function () {
                this.data = {
                    year: parseInt(new Date().toISOString().split('-')[0]) + 543,
                    name: '',
                    start_date: new Date().toISOString().split('-')[0] + '-01-01',
                    end_date: new Date().toISOString().split('-')[0] + '-12-31',
                    admin_use: false,
                    onetime: false
                };
            },
            _insert: function () {
                this.$$('panel-right').open();
                this.clearData();
                this.CLEAR_WELFARE(this.data);
                this.CLEAR_WELFARE_ID();
                this.pages = 0;
                this.active = false;
                this.$$('welfare-panel').checked_tab('#tab1');
                this.set('title', this.title = "เพิ่มสวัสดิการ");
            },
            _edit: function (e) {
                // console.log(e.currentTarget.data);
                var id = e.currentTarget.data.id;
                this.SELECT_DATA(id);
                this.LIST_WELFARE_ID(id);
                this.$$('panel-right').open();
                this.pages = 0;
                this.active = true;
                this.$$('welfare-panel').checked_tab('#tab1');
                this.set('title', this.title = "แก้ไขสวัสดิการ");
            },
            changeYear: function (e) {
                if(typeof e.detail == 'undefined'){
                    var year = e - 543;
                    this.LIST_WELFARE(year);
                }
                else{
                    var year = e.detail;
                    this.LIST_WELFARE(year);
                }
            },
            _print: function () {
                this.fire('nylon-change-page', { path: '/report' })
            },
            _openDialog:function(){
                this.$.clone_welfare.open();
                this.year = '';
                this.data_clone = [];
            },
            _cloneData:function(year){
                if(year !== ''){
                    this.CLONE_DATA(year);
                }
            },
            _submitClone:function(){
                var arr = [];
                var data = this.data_clone.filter((val) => {
                    if(val.check == true){
                        arr.push({id:val.id});
                    }
                })
                this.cloneGroupid = arr;
                this.$.dialogInput.open();
            },
            _clickCheckedData:function(e){
                var index = e.model.index;
                if(this.data_clone[index].check === undefined || this.data_clone[index].check === false){
                    this.set(`data_clone.${index}.check`,!this.data_clone[index].check);
                }else{
                    this.set(`data_clone.${index}.check`,!this.data_clone[index].check);
                }
                if(this.data_clone[index].check === false)
                    this.set('selectDataAll', false)
                
            },
            _insertClone:function(e){
                if(e.code == 'Enter'){
                    var obj = {};
                    obj.year = parseInt(this.yearClone.year)-543;
                    obj.cloneGroupid = this.cloneGroupid;
                    this.dispatchAction('INSERT_CLONE_DATA',obj);
                }
            },
            _closeDialog:function(){
                this.$.clone_welfare.close();
                this.$.dialogInput.close();
            },
            _changeselectDataAll:function(val){
                try {
                    this.data_clone.map((item,index)=>{
                        this.set('data_clone.'+index+'.check',this.selectDataAll);
                    });
                } catch (error) {
                    
                }
            },
            _obData:function(data){
                if(data.length > 0){
                    this.set('selectDataAll', false)
                    return true
                }else{
                    return false
                }
            },
            _checkData:function(e){
                var index = e.model.index;
                if(this.data_clone[index].check === false){
                    this.set('selectDataAll', false)
                }
            },
            _obChecked:function(data){
                try {
                    var checkTrue = this.data_clone.filter((val) => {
                                        return val.check == true
                                    })
                    if(checkTrue.length > 0){
                        this.isHidden = false;
                    }else{
                        this.isHidden = true;
                    }
                } catch (error) {
                    
                }
            }
        });
    </script>
</dom-module>